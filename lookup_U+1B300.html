<html>
  <head>
    <script src="jquery.min.js" type="text/javascript"></script>
    <style>
      div.navigator {
        position: fixed !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #E0E0E0;
      }
      span.sound {
        display: inline-block;
        width: 150px;
        margin-left: 25px;
      }
      span.ucs-roman {
      }
      span.ucs-ipa {
        color: red;
      }
      span.pat-sdyz {
        margin-right: 5em;
      }
    </style>
  </head>
  <body>
    <div class="navigator">
      <input id="phonetic_roman" type="text" disabled>
    </div>
    <div class="results">
      <div id="sdyz_ipa_results">
        <ul></ul>
      </div>
      <div id="ucs_results">
        <ul></ul>
      </div>
    </div>
    <script>
      // ------------------------------------------------------
      // polyfill

      // includes()
      if (!Array.prototype.includes) {
        Array.prototype.includes = function(o) {
          if (0 > this.indexOf(o))
            return false;
          else
            return true;
        };
      };
      if (!String.prototype.includes) {
        String.prototype.includes = function(search, start) {
          if (typeof start !== 'number') {
            start = 0;
          }
    
          if (start + search.length > this.length) {
            return false;
          } else {
            return this.indexOf(search, start) !== -1;
          }
        };
      }

      // startsWith()
      if (!String.prototype.startsWith) {
        String.prototype.startsWith = function(searchString, position){
          position = position || 0;
          return this.substr(position, searchString.length) === searchString;
        };
      }

      // String.repeat() is since ES6
      if (!String.prototype.repeat) {
        String.prototype.repeat = function(len) {
          var r = "";
          for (var i = 0; i < len; i ++ ) {
            r = r + this;
          };
          return r;
        };
      };

      // short notation to get last member from an array
      if (!Array.prototype.last) {
        Array.prototype.last = function() {
          return this[ this.length - 1];
        };
      };
   
      // -------------------------------------------------------
      Object.prototype.getSyllable = function(doCapitalize, ignoreTone) {
        if (!this.roman || this.roman.length == 0) {
          return null;
        }

        var basename = "";
        this.roman.forEach(function(tok, idx){
          if (idx > 0) {
            // non-initial consonant would be concatenated after an apostroph
            if (/^[A-Z]/.test(tok) && !doCapitalize) {
              basename += "\'";
            }
            // insert hyphen if capitalized
            if (doCapitalize) {
              basename += "-";
            }
          }
          if (doCapitalize) {
            tok = tok.toUpperCase();
          };
          basename += tok;
        });
        if (ignoreTone) {
          return basename;
        }
        return (basename + this.tone.toString(10));
      };

      Array.prototype.getCharName = function(sepSyllable, doCapitalize, ignoreTone) {
        var sep = sepSyllable;
        if (sep == null || sep == undefined) {
          sep = " ";
        }

        var charName = this.map(function(syl){
          return syl.getSyllable(doCapitalize, ignoreTone);
        }).filter(function(syl){
          return (syl != null);
        }).join(sep);

        if (this.last().glyph_suffix) {
          charName += this.last().glyph_suffix;
        }

        return charName;
      };

      Array.prototype.getIPA = function(sepSyllable) {
        var sep = sepSyllable;
        if (sep == null || sep == undefined) {
          sep = " ";
        }

        return this.map(function(syl){
          var ucsInt = 0;
          var r = null;
          if (syl.ipa) {
            r = syl.ipa.join("");
            if (r && syl.tone) {
              switch (syl.tone) {
                case 1:
                  ucsInt = 0x00B9;
                  break;
                case 2:
                case 3:
                  ucsInt = (syl.tone - 2) + 0x00B2;
                  break;
                default:
                  ucsInt = syl.tone + 0x2070;
              }
              r += String.fromCharCode(ucsInt);
            }
          }
          return r;
        }).filter(function(syl){
          return (syl != null);
        }).join(sep);
      };

      // -------------------------------------------------------

      var Opts = new Object();
      Opts.keyupTimeout = 100;
      Opts.isRemote = (document.location.protocol != "file:");
      document.rPhonetic = $("#phonetic_roman");
      document.zResults = $("#sdyz_ipa_results > ul");
      document.uResults = $("#ucs_results > ul");

      Opts.queryForSdyzIpa = function(queryText) {
        var sdyzIpaFounds = new Array();
        var pats = queryText.toUpperCase().split("/");
        pats.forEach(function(t){
          if (t.length == 0) {
            return [];
          }
          var foundKeys = Opts.sdyzRomanKeys.filter(function(rk){
            return rk.startsWith(t);
          });
          sdyzIpaFounds.push(foundKeys);
        });
        for (var i = 0; i < sdyzIpaFounds.length; i += 1) {
          var jqLi = $("<li>");
          jqLi.appendTo(document.zResults);

          var jqSpan = $("<span>");
          jqSpan.append(pats[i] + "~").addClass("pat-sdyz").appendTo(jqLi);

          for (var j = 0; j < sdyzIpaFounds[i].length; j += 1) {
            var jqImg = $("<img>").addClass("img-sdyz-ipa");
            jqImg.attr("src", Opts.config.imgDir.sdyz_ipa + "/" + sdyzIpaFounds[i][j] + ".gif");
            jqImg.css("height", "50px");
            jqImg.attr("title", sdyzIpaFounds[i][j]);
            jqImg.appendTo(jqLi);
          };
        };
      };

      Opts.queryForUcs = function(queryText) {
        var ucsFounds = new Array();
        Object.keys(Opts.hex2sounds).filter(function(ucs){
          return (ucs.slice(0,2).toUpperCase() == "U+");
        }).forEach(function(ucs){
          var charName = Opts.hex2sounds[ucs].getCharName("", false, true);
          console.log("q=" + queryText + " charName=" + charName);
          if (charName.toLowerCase().replace(/[^0-9A-Za-z]/, "").startsWith(queryText)) {
            ucsFounds.push(ucs);
          }
        });

        for (var i = 0; i < ucsFounds.length; i += 1) {
          var ucs = ucsFounds[i];
          var jqLi = $("<li>");
          jqLi.appendTo(document.uResults);

          var jqSpan = $("<span>").addClass("ucs-hex");
          jqSpan.append(ucs).appendTo(jqLi);

          var jqImg = $("<img>").addClass("img-ucs");
          jqImg.attr("src", Opts.config.imgDir.ucs + "/" + ucs + ".gif");
          // jqImg.css("height", "50px");
          jqImg.attr("title", ucs);
          jqImg.appendTo(jqLi);

          var jqSpan = $("<span>").addClass("sound").addClass("ucs-roman");
          jqSpan.append(Opts.hex2sounds[ucs].getCharName("_", false, false));
          jqSpan.appendTo(jqLi);

          var jqSpan = $("<span>").addClass("sound").addClass("ucs-ipa");
          jqSpan.append(Opts.hex2sounds[ucs].getIPA(" "));
          jqSpan.appendTo(jqLi);
        };
      };

      Opts.funcQuery = function() {
        document.zResults.empty();
        document.uResults.empty();

        var queryText = document.rPhonetic.val();
        Opts.queryForSdyzIpa( queryText );
        Opts.queryForUcs( queryText.replace(/[^0-9A-Za-z]/, "") );
      };

      Opts.queryTimer = null;
      document.rPhonetic.keyup(function(evt)
        {
          document.rPhonetic.css("background-color", "white");

          if (Opts.queryTimer) {
            clearTimeout(Opts.queryTimer);
          }
          if (document.rPhonetic.val().length != document.rPhonetic.prop("oldStringLength")) {
            Opts.queryTimer = setTimeout(function(){Opts.funcQuery();}, Opts.keyupTimeout);
          }
          document.rPhonetic.prop("oldStringLength", document.rPhonetic.val().length);
        }
      );

      document.rPhonetic.focusout(function(){Opts.funcQuery();});



      var loadSingleJson = function(basename, objname) {
        var jqd = $.Deferred();

        if (objname == null) {
          objname = basename.split(".")[0];
        }
        var jsonUrl = basename;
        if (Opts.isRemote) {
          var toks = document.location.href.split("/");
          toks.pop();
          toks.push(basename);
          jsonUrl = toks.join("/");
        }

        var xhr = new XMLHttpRequest();
        xhr.open("GET", jsonUrl, false);
        xhr.onload = function(evt) {
          if (xhr.readyState == 4 && (!Opts.isRemote || xhr.status == 200)) {
            var db = JSON.parse( xhr.responseText );
            if (Opts[objname] == undefined) {
              Opts[objname] = db;
            } else {
              Object.keys(db).forEach(function(k){
                Opts[objname][k] = db[k];
              });
            }
            jqd.resolve();
          }
        };
        xhr.send();
        return jqd.promise();
      };

      var setupSdyz = function(){
        var jqd = $.Deferred();
        Opts.sdyzRoman2Ipa = Opts.sdyzSounds._sound_table;
        Opts.sdyzRomanKeys = Object.keys(Opts.sdyzRoman2Ipa);
        var jqp = jqd.promise();
        jqd.resolve();
        return jqp;
      };

      var enableUi = function(){
        document.rPhonetic.prop("disabled", false);
      };

      $.when(loadSingleJson("ShuishuLogogramNameList.json", "hex2sounds"),
             loadSingleJson("SDYZSound.json", "sdyzSounds"),
             loadSingleJson("config.json")
      ).then(setupSdyz)
       .then(enableUi);

      $("div.results").css("margin-top", $("div.navigator").height() + 10);
    </script>
  </body>
</html>
