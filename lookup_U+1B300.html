<html>
  <head>
    <script src="jquery.min.js" type="text/javascript"></script>
    <style>
      div.navigator {
        position: fixed !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #E0E0E0;
      }
      #sdyz_ipa_results {
        border: 1px solid black;
      }
      #ucs_results {
        border: 1px solid black;
      }
      span.sound {
        display: inline-block;
        width: 150px;
        margin-left: 25px;
      }
      span.ucs-roman {
      }
      span.ucs-ipa {
        color: red;
      }
      span.pat-sdyz {
        margin-right: 25px;
      }
      span.ucs-meaning {
      }
    </style>
  </head>
  <body>
    <div class="navigator">
      <input id="phonetic_roman" type="text" disabled>
    </div>
    <div class="results">
      <div id="sdyz_ipa_results">
        <div class="desc-for-empty-list">
        elementary sounds in SDYZ2007.
        </div>
        <ul style="display: none;"></ul>
      </div>
      <div id="ucs_results">
        <div class="desc-for-empty-list">
        characters in WG2 N4922.
        </div>
        <ul style="display: none;"></ul>
      </div>
    </div>
    <script>
      // ------------------------------------------------------
      // polyfill

      // includes()
      if (!Array.prototype.includes) {
        Array.prototype.includes = function(o) {
          if (0 > this.indexOf(o))
            return false;
          else
            return true;
        };
      };
      if (!String.prototype.includes) {
        String.prototype.includes = function(search, start) {
          if (typeof start !== 'number') {
            start = 0;
          }
    
          if (start + search.length > this.length) {
            return false;
          } else {
            return this.indexOf(search, start) !== -1;
          }
        };
      }

      // startsWith()
      if (!String.prototype.startsWith) {
        String.prototype.startsWith = function(searchString, position){
          position = position || 0;
          return this.substr(position, searchString.length) === searchString;
        };
      }

      // String.repeat() is since ES6
      if (!String.prototype.repeat) {
        String.prototype.repeat = function(len) {
          var r = "";
          for (var i = 0; i < len; i ++ ) {
            r = r + this;
          };
          return r;
        };
      };

      // -------------------------------------------------------

      // short notation to get last member from an array
      if (!Array.prototype.last) {
        Array.prototype.last = function() {
          return this[ this.length - 1];
        };
      };

      // split the string into the array of "string" and "single XML entity reference"
      if (!String.prototype.splitForEntityRef) {
        String.prototype.splitForEntityRef = function() {
          var r = new Array();
          var r0 = this.split("&");
          if (r0[0].length > 0) {
            r.push( r0.shift() );
          }

          while (r0.length > 0) {
            var origToken = "&" + r0.shift();
            var r1 = origToken.split(";", 2);
            r.push( r1[0] + ";" );
            r.push( r1[1] );
          }
          return r;
        }
      }

      // -------------------------------------------------------
      Object.prototype.getSyllable = function(doCapitalize, ignoreTone) {
        if (!this.roman || this.roman.length == 0) {
          return null;
        }

        var basename = "";
        this.roman.forEach(function(tok, idx){
          if (idx > 0) {
            // non-initial consonant would be concatenated after an apostroph
            if (/^[A-Z]/.test(tok) && !doCapitalize) {
              basename += "\'";
            }
            // insert hyphen if capitalized
            if (doCapitalize) {
              basename += "-";
            }
          }
          if (doCapitalize) {
            tok = tok.toUpperCase();
          };
          basename += tok;
        });
        if (ignoreTone) {
          return basename;
        }
        return (basename + this.tone.toString(10));
      };

      Array.prototype.getCharName = function(sepSyllable, doCapitalize, ignoreTone) {
        var sep = sepSyllable;
        if (sep == null || sep == undefined) {
          sep = " ";
        }

        var charName = this.map(function(syl){
          return syl.getSyllable(doCapitalize, ignoreTone);
        }).filter(function(syl){
          return (syl != null);
        }).join(sep);

        if (this.last().glyph_suffix) {
          charName += this.last().glyph_suffix;
        }

        return charName;
      };

      String.prototype.toSuperScript = function() {
        var superScripts = {
          "0": "\u2070",
          "1": "\u00B9",
          "2": "\u00B2",
          "3": "\u00B3",
          "4": "\u2074",
          "5": "\u2075",
          "6": "\u2076",
          "7": "\u2077",
          "8": "\u2078",
          "9": "\u2079",
          "-": "\u207B"
        };
        var r = "";
        for (var i = 0; i < this.length; i += 1) {
          if (superScripts[ this[i] ]) {
            r += superScripts[ this[i] ];
          }
        };
        return r;
      };

      Number.prototype.fromSuiToneNumberToPitchValues = function() {
        var t2p = [ null, "13", "31", "33", "52", "35", "55", "55-35", "32-42" ];
        return t2p[this];
      };

      Array.prototype.getIPA = function(sepSyllable) {
        var sep = sepSyllable;
        if (sep == null || sep == undefined) {
          sep = " ";
        }

        return this.map(function(syl){
          var ucsInt = 0;
          var r = null;
          if (syl.ipa) {
            r = syl.ipa.join("");
            if (r && syl.tone) {
              var pitches = syl.tone.fromSuiToneNumberToPitchValues();
              if (pitches.includes("-")) {
                if (r.includes(":") || r.includes("\u02D0")) {
                  pitches = pitches.split("-").pop();
                } else {
                  pitches = pitches.split("-").shift();
                }
              }
              r += pitches.toSuperScript();
            }
          }
          return r;
        }).filter(function(syl){
          return (syl != null);
        }).join(sep);
      };

      // -------------------------------------------------------

      var Opts = new Object();
      Opts.keyupTimeout = 100;
      Opts.isRemote = (document.location.protocol != "file:");
      document.rPhonetic = $("#phonetic_roman");
      document.zResults = $("#sdyz_ipa_results > ul");
      document.uResults = $("#ucs_results > ul");

      Opts.queryForSdyzIpa = function(queryText) {
        var sdyzIpaFounds = new Array();
        var pats = queryText.toUpperCase().split("/");
        pats.forEach(function(t){
          if (t.length == 0) {
            return [];
          }
          var foundKeys = Opts.sdyzRomanKeys.filter(function(rk){
            return rk.startsWith(t);
          });
          sdyzIpaFounds.push(foundKeys);
        });

        if (sdyzIpaFounds.length == 0) {
          $("#sdyz_ipa_results > div.desc-for-empty-list").show();
          document.zResults.hide();
        } else {
          $("#sdyz_ipa_results > div.desc-for-empty-list").hide();
          document.zResults.show();
        }

        for (var i = 0; i < sdyzIpaFounds.length; i += 1) {
          var jqLi = $("<li>");
          jqLi.appendTo(document.zResults);

          var jqSpan = $("<span>");
          jqSpan.append(pats[i] + "...").addClass("pat-sdyz").appendTo(jqLi);

          for (var j = 0; j < sdyzIpaFounds[i].length; j += 1) {
            var jqImg = $("<img>").addClass("img-sdyz-ipa");
            jqImg.attr("src", Opts.config.imgDir.sdyz_ipa + "/" + sdyzIpaFounds[i][j] + ".gif");
            jqImg.css("height", "50px");
            jqImg.attr("title", sdyzIpaFounds[i][j]);
            jqImg.appendTo(jqLi);
          };
        };
      };

      Opts.getPageForCssSpriteFromUcs = function(ucs) {
        var ucs2page = Opts.config.cssSprite.ucs.ucs2page;
        for (var i = 0; i < ucs2page.length; i += 1) {
          var itm = ucs2page[i];
          if (itm.range[0] <= ucs && ucs <= itm.range[1]) {
            return itm.page; 
          }
        };
        return -1;
      };

      Opts.queryForUcs = function(queryText) {
        var ucsFounds = new Array();
        if (/^(U\+1B[3-5][0-9A-F]{2},?)+.*$/.test(queryText)) {
          ucsFounds = queryText.split(",").filter(function(tok){return /U\+1B[3-5][0-9A-F]/.test(tok);});
        } else {
          queryText = queryText.replace(/[^0-9A-Za-z]/, "");
          Object.keys(Opts.hex2sounds).filter(function(ucs){
            return (ucs.slice(0,2).toUpperCase() == "U+");
          }).forEach(function(ucs){
            var charName = Opts.hex2sounds[ucs].getCharName("", false, true);
            console.log("q=" + queryText + " charName=" + charName);
            if (charName.toLowerCase().replace(/[^0-9A-Za-z]/, "").startsWith(queryText)) {
              ucsFounds.push(ucs);
            }
          });
        }

        if (ucsFounds.length == 0) {
          $("#ucs_results > div.desc-for-empty-list").show();
          document.uResults.hide();
        } else {
          $("#ucs_results > div.desc-for-empty-list").hide();
          document.uResults.show();
        }

        if (Opts.hex2sounds._n4696_attr && Opts.config.sortBy == "n4696seq") {
          ucsFounds = ucsFounds.sort(function(ucs1, ucs2){
            return (parseInt(Opts.hex2sounds._n4696_attr[ucs1].N4696_seq) - parseInt(Opts.hex2sounds._n4696_attr[ucs2].N4696_seq));
          });
        }

        for (var i = 0; i < ucsFounds.length; i += 1) {
          var ucs = ucsFounds[i];
          var jqLi = $("<li>");
          jqLi.appendTo(document.uResults);

          var jqSpan = $("<span>").addClass("ucs-hex");
          jqSpan.append(ucs).appendTo(jqLi);

          var jqImg = $("<img>")
                      .addClass("img-ucs")
                      .attr("title", ucs);
          if (!Opts.config.cssSprite) {
            // cropped glyph images
            jqImg.attr("src", Opts.config.imgDir.ucs + "/" + ucs + ".gif");
          } else {
            // css sprite
            jqImg.attr("src", "1x1.gif")
                 .addClass(ucs.replace("+", "-"))
                 .addClass("n4922-" + Opts.getPageForCssSpriteFromUcs(ucs).toString() );
          };
          jqImg.appendTo(jqLi);

          var jqSpan = $("<span>").addClass("sound").addClass("ucs-roman");
          jqSpan.append(Opts.hex2sounds[ucs].getCharName("_", false, false));
          jqSpan.appendTo(jqLi);

          var jqSpan = $("<span>").addClass("sound").addClass("ucs-ipa");
          jqSpan.append(Opts.hex2sounds[ucs].getIPA(" "));
          jqSpan.appendTo(jqLi);

          var n4696_attr = Opts.hex2sounds._n4696_attr ?  Opts.hex2sounds._n4696_attr[ucs] : null;
          if (!n4696_attr) continue;

          var jqSpan = $("<span>").addClass("meaning");
          jqSpan.append(n4696_attr.N4696_seq + ":" + n4696_attr.N4696_meaning);
          jqSpan.appendTo(jqLi);
        };
      };

      Opts.funcQuery = function() {
        document.zResults.empty();
        document.uResults.empty();

        var queryText = document.rPhonetic.val();
        Opts.queryForSdyzIpa( queryText );
        Opts.queryForUcs( queryText )
      };

      Opts.queryTimer = null;
      document.rPhonetic.keyup(function(evt)
        {
          document.rPhonetic.css("background-color", "white");

          if (Opts.queryTimer) {
            clearTimeout(Opts.queryTimer);
          }
          if (document.rPhonetic.val().length != document.rPhonetic.prop("oldStringLength")) {
            Opts.queryTimer = setTimeout(function(){Opts.funcQuery();}, Opts.keyupTimeout);
          }
          document.rPhonetic.prop("oldStringLength", document.rPhonetic.val().length);
        }
      );

      document.rPhonetic.focusout(function(){Opts.funcQuery();});



      var loadSingleJson = function(basename, objname) {
        var jqd = $.Deferred();

        if (objname == null) {
          objname = basename.split(".")[0];
        }
        var jsonUrl = basename;
        if (Opts.isRemote) {
          var toks = document.location.href.split("/");
          toks.pop();
          toks.push(basename);
          jsonUrl = toks.join("/");
        }

        var xhr = new XMLHttpRequest();
        xhr.open("GET", jsonUrl);
        xhr.onload = function(evt) {
          if (xhr.readyState == 4 && (!Opts.isRemote || xhr.status == 200)) {
            var db = JSON.parse( xhr.responseText );

            var objname_toks = objname.split(".");
            var dest_db = Opts;
            while (objname_toks.length > 0) {
              var objname_tok = objname_toks.shift();
              if (dest_db[objname_tok] == undefined || dest_db[objname_tok] == true) {
                dest_db[objname_tok] = new Object();
              }
              dest_db = dest_db[objname_tok];
            }
            Object.keys(db).forEach(function(k){
              dest_db[k] = db[k];
            });
            jqd.resolve();
          } else
          if (xhr.readyState == 4) {
            jqd.reject(); 
          }
        };
        xhr.send();
        return jqd.promise();
      };

      var setupCssSprite = function() {
        var jqd = $.Deferred();
        if (!Opts.config.cssSprite) {
          jqd.resolve();
          return jqd.promise();
        }

        var jqd2 = loadSingleJson(Opts.config.imgDir.ucs + "/cssSprite.json", "config.cssSprite.ucs");
        jqd2.fail(function(){
          Opts.config.cssSprite = false;
          jqd.resolve();
        });
        jqd2.done(function(){
          var jqLink = $("<link>")
                       .attr("href", Opts.config.imgDir.ucs + "/cssSprite.css")
                       .attr("rel", "stylesheet")
                       .attr("type", "text/css");
          $(document.head).append(jqLink);
          jqd.resolve();
        });
        return jqd.promise(); 
      };

      var setupSdyz = function(){
        var jqd = $.Deferred();
        Opts.sdyzRoman2Ipa = Opts.sdyzSounds._sound_table;
        Opts.sdyzRomanKeys = Object.keys(Opts.sdyzRoman2Ipa);
        var jqp = jqd.promise();
        jqd.resolve();
        return jqp;
      };

      var enableUi = function(){
        document.rPhonetic.prop("disabled", false);
      };

      $.when(loadSingleJson("ShuishuLogogramNameList.json", "hex2sounds"),
             loadSingleJson("SDYZSound.json", "sdyzSounds"),
             loadSingleJson("config.json")
      ).then(setupSdyz)
       .then(setupCssSprite)
       .then(enableUi);

      $("div.results").css("margin-top", $("div.navigator").height() + 10);
    </script>
  </body>
</html>
